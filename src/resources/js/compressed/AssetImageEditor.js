Craft.AssetImageEditor=Garnish.Modal.extend({$body:null,$tools:null,$buttons:null,$cancelBtn:null,$replaceBtn:null,$saveBtn:null,$editorContainer:null,$straighten:null,canvas:null,image:null,viewport:null,viewportMask:null,assetId:null,cacheBust:null,zoomRatio:1,croppingCanvas:null,clipper:null,cropper:null,croppingShade:null,tiltedImageVerticeCoords:null,lastValidCroppingCoordinates:null,lastValidCroppingScales:null,previousScreenX:0,previousScreenY:0,isCroppingPerformed:!1,appliedFilter:null,appliedFilterOptions:{},editorHeight:0,editorWidth:0,viewportWidth:0,viewportHeight:0,imageAngle:0,imageStraightenAngle:0,viewportRotation:0,originalWidth:0,originalHeight:0,animationInProgress:!1,init:function(a,b){this.cacheBust=Date.now(),this.setSettings(b,Craft.AssetImageEditor.defaults),this.assetId=a;var c=$('<div class="modal asset-editor"></div>').appendTo(Garnish.$bod),d=$('<div class="body"><div class="spinner big"></div></div>').appendTo(c),e=$('<div class="footer"/>').appendTo(c);this.base(c,this.settings),this.$buttons=$('<div class="buttons rightalign"/>').appendTo(e),this.$cancelBtn=$('<div class="btn cancel">'+Craft.t("app","Cancel")+"</div>").appendTo(this.$buttons),this.$replaceBtn=$('<div class="btn submit save replace">'+Craft.t("app","Replace Asset")+"</div>").appendTo(this.$buttons),this.settings.allowSavingAsNew&&(this.$saveBtn=$('<div class="btn submit save copy">'+Craft.t("app","Save as New Asset")+"</div>").appendTo(this.$buttons)),this.$body=d,this.addListener(this.$cancelBtn,"activate",$.proxy(this,"hide")),this.removeListener(this.$shade,"click"),Craft.postActionRequest("assets/image-editor",$.proxy(this,"loadEditor"))},loadEditor:function(a){this.$body.html(a.html),this.$tools=$(".image-tools",this.$body),this.canvas=new fabric.StaticCanvas("image-canvas",{backgroundColor:this.backgroundColor,hoverCursor:"default"}),this.canvas.enableRetinaScaling=!0,this.$editorContainer=$("#image-holder"),this.$straighten=$(".rotate.straighten"),this.editorHeight=this.$editorContainer.innerHeight(),this.editorWidth=this.$editorContainer.innerWidth();var b=Craft.getActionUrl("assets/edit-image",{assetId:this.assetId,size:this.settings.assetSize,cacheBust:this.cacheBust});fabric.Image.fromURL(b,$.proxy(function(a){this.image=a,this.originalHeight=this.image.getHeight(),this.originalWidth=this.image.getWidth(),this._scaleAndCenterImage(),this.zoomRatio=this.getZoomToCoverRatio(),this._renewImageZoomRatio(),this.viewportMask=this._createViewportMask({width:this.viewportWidth,height:this.viewportHeight,top:this.image.top-1,left:this.image.left-1}),this.viewport=new fabric.Group([this.image,this.viewportMask],{originX:"center",originY:"center",selectable:!1}),this.canvas.add(this.viewport),this._addListeners(),this._drawGrid(),this._prepareImageForRotation(),this.canvas.renderAll()},this))},_scaleAndCenterImage:function(){this.image.height>this.image.width?(this.viewportHeight=this.editorHeight,this.image.height=this.viewportHeight,this.image.width=Math.round(this.originalWidth*(this.image.height/this.originalHeight)),this.viewportWidth=this.image.width):(this.viewportWidth=this.editorWidth,this.image.width=this.viewportWidth,this.image.height=Math.round(this.originalHeight*(this.image.width/this.originalWidth)),this.viewportHeight=this.image.height),this.image.set({originX:"left",originY:"top",left:(this.editorWidth-this.image.width)/2,top:(this.editorHeight-this.image.height)/2}),this.canvas.setDimensions({width:this.editorWidth,height:this.editorHeight})},_renewImageZoomRatio:function(){this.image.scale(this.zoomRatio)},_createViewportMask:function(a){var b=new fabric.Rect({width:a.width,height:a.height,fill:"#000",left:a.left+a.width/2,top:a.top+a.height/2,originX:"center",originY:"center"});return b.globalCompositeOperation="destination-in",b},_addListeners:function(){var a=function(a){return function(b){this.isActiveControl($(b.currentTarget))?a.call(this,b):(b.preventDefault(),b.stopPropagation())}.bind(this)}.bind(this);this.addListener($(".rotate.counter-clockwise"),"click",a(function(){this.rotateViewport(-90)})),this.addListener($(".rotate.clockwise"),"click",a(function(){this.rotateViewport(90)})),this.addListener($(".rotate.reset"),"click",a(function(a){this.resetStraighten(a)})),this.addListener($(".rotate.straighten"),"input change mouseup mousedown click",a(function(a){this.straighten(a)})),this.addListener($(".filter-select select",this.$tools),"change",a(function(a){$option=$(a.currentTarget).find("option:selected"),$(".filter-fields").addClass("hidden"),$option.val()&&$(".filter-fields[filter="+$option.val()+"]").removeClass("hidden")})),this.addListener($(".filter-tools .btn.apply-filter",this.$tools),"click",a(function(a){this.applyFilter(a)})),this.addListener($(".cropping-tool",this.$tools),"click",a(function(a){this.enableCropMode(a)})),this.addListener($(".reset-crop",this.$tools),"click",a(function(a){this.cancelCropMode(a)})),this.addListener($(".apply-crop",this.$tools),"click",a(function(a){this.applyCrop(a)})),this.addListener($(".btn.cancel",this.$buttons),"click",$.proxy(this,"hide")),this.addListener($(".btn.save",this.$buttons),"click",$.proxy(this,"saveImage"))},rotateViewport:function(a){if(!this.animationInProgress){this.discardCrop(),this.animationInProgress=!0,this.viewportRotation+=a,this.viewportRotation=parseInt((this.viewportRotation+360)%360,10);var b=this.viewport.getAngle()+a;this.viewport.animate("angle",b,{onChange:this.canvas.renderAll.bind(this.canvas),duration:this.settings.animationDuration,onComplete:$.proxy(function(){var a=parseInt((this.viewport.getAngle()+360)%360,10);this.viewport.set({angle:a}),this.animationInProgress=!1,this.getZoomToCoverRatio()},this)})}},straighten:function(a){if(!this.animationInProgress){this.discardCrop(),this.animationInProgress=!0,a&&("change"==a.type||"click"==a.type?this.hideGrid():this.showGrid());var b=parseInt(this.$straighten.val(),10);this._prepareImageForRotation(),this.image.set({angle:parseInt((b+360)%360,10)}),this.zoomRatio=this.getZoomToCoverRatio(),this._renewImageZoomRatio(),this._destroyCropper(),this.canvas.renderAll(),this.animationInProgress=!1}},resetStraighten:function(){this.animationInProgress||(this.$straighten.val(0),this.straighten())},saveImage:function(a){if($button=$(a.currentTarget),$button.hasClass("disabled"))return!1;$(".btn",this.$buttons).addClass("disabled"),this.$buttons.append('<div class="spinner"></div>');var b={assetId:this.assetId,viewportRotation:this.viewportRotation,imageRotation:this.imageStraightenAngle,replace:$button.hasClass("replace")?1:0},c=this.appliedFilter;if(c){b.filter=c;var d=this.appliedFilterOptions;for(var e in d)b["filterOptions["+e+"]"]=encodeURIComponent(d[e])}Craft.postActionRequest("assets/save-image",b,$.proxy(function(){this.$buttons.find(".btn").removeClass("disabled").end().find(".spinner").remove(),this.onSave(),this.hide()},this))},getZoomToCoverRatio:function(){this.imageStraightenAngle=parseFloat(this.$straighten.val());var a=Math.abs(this.imageStraightenAngle)*(Math.PI/180),b=Math.sin(a)*this.viewportHeight+Math.cos(a)*this.viewportWidth,c=Math.sin(a)*this.viewportWidth+Math.cos(a)*this.viewportHeight;return Math.max(b/this.viewportWidth,c/this.viewportHeight)},getZoomToFitRatio:function(){this.imageStraightenAngle=parseFloat(this.$straighten.val());var a=Math.abs(this.imageStraightenAngle)*(Math.PI/180),b=this.originalWidth/this.originalHeight,c=this.viewportWidth/(Math.cos(a)*b+Math.sin(a)),d=c*b;return Math.max(c/this.viewportHeight,d/this.viewportWidth)},_drawGrid:function(){var a={strokeWidth:this.settings.gridLineThickness,opacity:1,stroke:this.settings.gridLineColor},b=this.viewportWidth,c=this.viewportHeight,d=[new fabric.Line([0,0,b-1,0],a),new fabric.Line([0,c-1,0,0],a),new fabric.Line([b-1,0,b-1,c-1],a),new fabric.Line([b,c-1,0,c-1],a)],e=$.proxy(function(b,c,f,g,h){var i=Math.ceil(c/2-this.settings.gridLineThickness/2+f);pointOptions="x"==h?[0,i,g,i]:[i,0,i,g],a.opacity=1-(b-1)*(1/this.settings.gridLinePrecision),d.push(new fabric.Line(pointOptions,a)),b<this.settings.gridLinePrecision&&(e(b+1,c/2,f,g,h),e(b+1,c/2,f+c/2,g,h))},this);e(1,b,0,c,"y"),e(1,c,0,b,"x"),this.grid=new fabric.Group(d,{left:this.image.left,top:this.image.top,opacity:0}),this.viewport.add(this.grid)},showGrid:function(){this.grid.set({opacity:1})},hideGrid:function(){this.grid.set({opacity:0})},onFadeOut:function(){this.destroy()},applyFilter:function(a){if($button=$(a.currentTarget),$button.hasClass("disabled"))return!1;$button.addClass("disabled"),$spinner=$('<div class="spinner filter-spinner"></div>').insertAfter($button);var b={assetId:this.assetId,size:this.settings.assetSize},c=this.getSelectedFilter();if(c){var d=this.getFilterOptions(c);if(c==this.appliedFilter&&JSON.stringify(this.appliedFilterOptions)==JSON.stringify(d))return $spinner.remove(),void $button.removeClass("disabled");this.appliedFilter=c,this.appliedFilterOptions=d,b.filter=c;for(var e in d)b["filterOptions["+e+"]"]=encodeURIComponent(d[e])}else{if(null==this.appliedFilter)return $spinner.remove(),void $button.removeClass("disabled");this.appliedFilterOptions={},this.appliedFilter=null}imageUrl=Craft.getActionUrl("assets/edit-image",b),this.image.setSrc(imageUrl,$.proxy(function(){this._scaleAndCenterImage(),this._prepareImageForRotation(),$spinner.remove(),$button.removeClass("disabled")},this))},getSelectedFilter:function(){return $(".filter-select",this.$tools).find("option:selected").val()},getFilterOptions:function(a){var b={};return $filterFields=$(".filter-fields[filter="+a+"]").find("input, select, textarea"),$filterFields.each(function(){$input=$(this),b[$input.prop("name")]=encodeURIComponent($input.val())}),b},onSave:function(){this.settings.onSave()},isActiveControl:function(a){return 0==a.parents(".disabled").length},enableCropMode:function(){this.zoomRatio=this.getZoomToFitRatio();var a=function(){$(".cropping-tools .crop-mode-enabled",this.$tools).removeClass("hidden"),$(".cropping-tools .crop-mode-disabled",this.$tools).addClass("hidden"),this.canvas.renderAll()}.bind(this);this.discardCrop(!0),this.showCropper(),this._switchEditingMode({mode:"crop",onFinish:a}),this.viewportMask.animate({width:this.editorWidth,height:this.editorHeight},{duration:this.settings.animationDuration}),this.canvas.renderAll()},cancelCropMode:function(){this.zoomRatio=this.getZoomToCoverRatio();var a=function(){$(".rotation-tools, .filter-tools",this.$tools).removeClass("disabled"),$(".cropping-tools .crop-mode-enabled",this.$tools).addClass("hidden"),$(".cropping-tools .crop-mode-disabled",this.$tools).removeClass("hidden"),this.canvas.renderAll()}.bind(this);this.hideCropper(),this._switchEditingMode({mode:"edit",onFinish:a}),this.viewportMask.animate({width:this.viewportWidth,height:this.viewportHeight},{duration:this.settings.animationDuration}),this.canvas.renderAll()},discardCrop:function(a){if(this.isCroppingPerformed){this._scaleAndCenterImage(),this._prepareImageForRotation();var b={width:this.viewportWidth,height:this.viewportHeight,top:this.image.top-1,left:this.image.left-1};a?this.viewportMask.set(b):this.viewportMask.animate(b,{duration:this.settings.animationDuration,onChange:this.canvas.renderAll.bind(this.canvas)}),this.canvas.renderAll(),this.isCroppingPerformed=!1}},applyCrop:function(){{var a=this.clipper.width*this.lastValidCroppingScales.x,b=this.clipper.height*this.lastValidCroppingScales.y,c={x:this.lastValidCroppingCoordinates.left+a/2+2,y:this.lastValidCroppingCoordinates.top+b/2+2},d=this.editorWidth/2-c.x,e=this.editorHeight/2-c.y;this.clipper.width,this.clipper.height}this.viewportMask.animate({width:a,height:b},{duration:this.settings.animationDuration}),this.image.animate({left:this.image.left+d,top:this.image.top+e},{onComplete:function(){$(".rotation-tools, .filter-tools",this.$tools).removeClass("disabled"),$(".cropping-tools .crop-mode-enabled",this.$tools).addClass("hidden"),$(".cropping-tools .crop-mode-disabled",this.$tools).removeClass("hidden")}.bind(this),onChange:this.canvas.renderAll.bind(this.canvas),duration:this.settings.animationDuration}),this.hideCropper(),this.isCroppingPerformed=!0},_switchEditingMode:function(a){if($(".rotation-tools, .filter-tools, .cropping-tools",this.$tools).addClass("disabled").find("select").prop("disabled",!0),"crop"==a.mode)var b=".cropping-tools";else var b=".cropping-tools, .rotation-tools, .filter-tools";this.image.animate({scaleX:this.zoomRatio,scaleY:this.zoomRatio},{onChange:this.canvas.renderAll.bind(this.canvas),duration:this.settings.animationDuration,onComplete:$.proxy(function(){$(b,this.$tools).removeClass("disabled").find("select").prop("disabled",!1),a.onFinish()},this)})},showCropper:function(){this.cropper||this._createCropper(),this.croppingCanvas.add(this.croppingShade),this.croppingCanvas.add(this.cropper),this.croppingCanvas.setActiveObject(this.cropper)},hideCropper:function(){this.cropper&&(this.croppingCanvas.remove(this.cropper),this.croppingCanvas.remove(this.croppingShade))},_createCropper:function(){this.croppingCanvas=new fabric.Canvas("cropping-canvas",{backgroundColor:"rgba(0,0,0,0)",hoverCursor:"default",selection:!1}),this.croppingCanvas.setDimensions({width:this.editorWidth,height:this.editorHeight}),$(".canvas-container",this.$editorContainer).css({position:"absolute",top:0,left:0}),this.croppingShade=new fabric.Rect({width:this.editorWidth,height:this.editorHeight,fill:"rgba(255,255,255,0.4)",left:0,top:0}),this.croppingShade.set({hasBorders:!1,hasControls:!1,selectable:!1,lockRotation:!0}),combinedRatio=0==this.imageStraightenAngle?1.2:this.getZoomToCoverRatio()/this.getZoomToFitRatio()*1.2;var a=this.viewportWidth/combinedRatio,b=this.viewportHeight/combinedRatio,c=[];this.clipper=new fabric.Rect({left:0,top:0,width:a,height:b,stroke:"black",fill:"rgba(128,0,0,1)",strokeWidth:0}),this.clipper.globalCompositeOperation="destination-out",c.push(this.clipper);var d=new fabric.Rect({left:0,top:0,width:a-1,height:b-1,fill:"rgba(0,0,0,0)",stroke:"rgba(255,255,255,0.8)",strokeWidth:2});c.push(d),this.cropper=new fabric.Group(c,{left:this.editorWidth/2-a/2-2,top:this.editorHeight/2-b/2-2,hoverCursor:"move"}),this.cropper.set({hasBorders:!1,lockRotation:!0,hasRotatingPoint:!1,borderOpacityWhenMoving:1,cornerColor:"rgba(255,255,255,0.8)",transparentCorners:!1,cornerSize:10,cornerStyle:"circle"}),this.lastValidCroppingCoordinates={left:this.cropper.left,top:this.cropper.top},this.lastValidCroppingScales={x:1,y:1},this._setTiltedVerticeCoordinates();var e=function(a,b){var c=b.target,d=Math.floor(c.width*c.scaleX),e=Math.floor(c.height*c.scaleY),f={x:Math.ceil(c.left)+2,y:Math.ceil(c.top)+2},g={x:f.x+d-4,y:f.y},h={x:g.x,y:g.y+e-4},i={x:f.x,y:h.y},j=this.arePointsInsideRectangle([f,g,h,i],this.tiltedImageVerticeCoords),k=d>=this.settings.minimumCropperSize.width&&e>=this.settings.minimumCropperSize.height;if(!j||!k){var l=!1;if(k&&"move"==a){b.e.screenX-this.previousScreenX,b.e.screenY-this.previousScreenY}c.set({scaleX:this.lastValidCroppingScales.x,scaleY:this.lastValidCroppingScales.y}),l||c.set({top:this.lastValidCroppingCoordinates.top,left:this.lastValidCroppingCoordinates.left})}this.lastValidCroppingScales={x:c.scaleX,y:c.scaleY},this.lastValidCroppingCoordinates={top:c.top,left:c.left},this.previousScreenX=b.e.screenX,this.previousScreenY=b.e.screenY}.bind(this);this.croppingCanvas.on({"object:moving":function(a){e.call(this,"move",a)}.bind(this),"object:scaling":function(a){e.call(this,"scale",a)}.bind(this)})},_setTiltedVerticeCoordinates:function(){var a=-1*this.imageStraightenAngle*(Math.PI/180),b=this.image.height*this.getZoomToFitRatio(),c=this.image.width*this.getZoomToFitRatio(),d=Math.cos(a)*b,e=Math.sin(a)*c,f=Math.cos(a)*c,g=Math.sin(a)*b,h=(this.editorHeight-(d+e))/2,i=(this.editorWidth-(g+f))/2;this.tiltedImageVerticeCoords={a:{x:i+f,y:h},b:{x:this.editorWidth-i,y:h+d},c:{x:i+g,y:this.editorHeight-h},d:{x:i,y:h+e}}},_destroyCropper:function(){this.clipper=null,this.cropper=null,this.croppingShade=null,this.croppingCanvas=null,$("#cropping-canvas").siblings(".upper-canvas").remove(),$("#cropping-canvas").parent(".canvas-container").before($("#cropping-canvas")),$(".canvas-container").remove()},arePointsInsideRectangle:function(a,b){for(var c=function(a,b){return{x:b.x-a.x,y:b.y-a.y}},d=function(a,b){return a.x*b.x+a.y*b.y},e=c(b.a,b.b),f=c(b.b,b.c),g=d(e,e),h=d(f,f),i=0;i<a.length;i++){var j=a[i],k=c(b.a,j),l=c(b.b,j),m=d(e,k),n=d(f,l),o=m>=0&&g>=m,p=n>=0&&h>=n;if(!o||!p)return!1}return!0},_prepareImageForRotation:function(){this.image.set({originX:"center",originY:"center",left:0,top:0}),this.canvas.renderAll()}},{defaults:{gridLineThickness:1,gridLineColor:"#000000",gridLinePrecision:2,animationDuration:100,assetSize:400,allowSavingAsNew:!0,minimumCropperSize:{width:50,height:50},onSave:$.noop}});
//# sourceMappingURL=AssetImageEditor.js.map