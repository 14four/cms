Craft.AssetImageEditor=Garnish.Modal.extend({$body:null,$footer:null,$tools:null,$buttons:null,$cancelBtn:null,$replaceBtn:null,$saveBtn:null,$editorContainer:null,$straighten:null,$croppingCanvas:null,canvas:null,image:null,viewportMask:null,grid:null,croppingCanvas:null,clipper:null,croppingRectangle:null,cropperHandles:null,croppingShade:null,imageAngle:0,imageStraightenAngle:0,viewportRotation:0,originalWidth:0,originalHeight:0,imageVerticeCoords:null,zoomRatio:1,animationInProgress:!1,currentView:"rotate",assetId:null,cacheBust:null,draggingCropper:!1,scalingCropper:!1,previousMouseX:0,previousMouseY:0,lockAspectRatio:!1,cropData:{},editorHeight:0,editorWidth:0,isCroppingPerformed:!1,init:function(a,b){this.cacheBust=Date.now(),this.setSettings(b,Craft.AssetImageEditor.defaults),this.assetId=a,this.$container=$('<form class="modal fitted imageeditor"></form>').appendTo(Garnish.$bod),this.$body=$('<div class="body"></div>').appendTo(this.$container),this.$footer=$('<div class="footer"/>').appendTo(this.$container),this.base(this.$container,this.settings),this.$buttons=$('<div class="buttons rightalign"/>').appendTo(this.$footer),this.$cancelBtn=$('<div class="btn cancel">'+Craft.t("app","Cancel")+"</div>").appendTo(this.$buttons),this.$replaceBtn=$('<div class="btn submit save replace">'+Craft.t("app","Replace Asset")+"</div>").appendTo(this.$buttons),this.settings.allowSavingAsNew&&(this.$saveBtn=$('<div class="btn submit save copy">'+Craft.t("app","Save as New Asset")+"</div>").appendTo(this.$buttons)),this.addListener(this.$cancelBtn,"activate",$.proxy(this,"hide")),this.removeListener(this.$shade,"click"),this.updateRequestedImageSize(),Craft.postActionRequest("assets/image-editor",$.proxy(this,"loadEditor"))},updateRequestedImageSize:function(){var a=Garnish.$doc.get(0).documentElement.clientWidth,b=Garnish.$doc.get(0).documentElement.clientHeight;this.requestedImageSize=Math.min(b,a)},loadEditor:function(a){this.$body.html(a.html),this.$tabs=$(".tabs li",this.$body),this.$viewsContainer=$(".views",this.$body),this.$views=$("> div",this.$viewsContainer),this.$imageTools=$(".image-container .image-tools",this.$body),this.straighteningInput=new SlideRuleInput("slide-rule",{onStart:function(){this._showGrid()}.bind(this),onChange:function(a){this.straighten(a)}.bind(this),onEnd:function(){this._hideGrid()}.bind(this)}),this.$editorContainer=$(".image-container .image",this.$body),this.editorHeight=this.$editorContainer.innerHeight(),this.editorWidth=this.$editorContainer.innerWidth(),this.updateSizeAndPosition(),this.canvas=new fabric.StaticCanvas("image-canvas"),this.canvas.enableRetinaScaling=!0;var b=Craft.getActionUrl("assets/edit-image",{assetId:this.assetId,size:this.requestedImageSize,cacheBust:this.cacheBust});fabric.Image.fromURL(b,$.proxy(function(a){this.image=a,this.originalHeight=this.image.getHeight(),this.originalWidth=this.image.getWidth(),this.zoomRatio=1,this.image.set({originX:"center",originY:"center"}),this.canvas.add(this.image),this._repositionImage(),this._createViewportMask(),this._addControlListeners(),this.canvas.renderAll(),this.showView("rotate")},this))},updateSizeAndPosition:function(){if(this.$container){var a=window.innerWidth,b=window.innerHeight;this.$container.css({width:a,"min-width":a,left:0,height:b,"min-height":b,top:0}),this.$body.css({height:b-58}),a<b?this.$container.addClass("vertical"):this.$container.removeClass("vertical"),this.$editorContainer&&this.image&&this._repositionImage()}},_repositionImage:function(){this.editorHeight=this.$editorContainer.innerHeight(),this.editorWidth=this.$editorContainer.innerWidth(),this.canvas.setDimensions({width:this.editorWidth,height:this.editorHeight}),"crop"==this.currentView?(this.zoomRatio=this.getZoomToFitRatio(this.getScaledImageDimensions()),this._setImageVerticeCoordinates()):this.zoomRatio=this.getZoomToCoverRatio(this.getScaledImageDimensions()),this._calculateViewportMask(),this._calculateImagePosition(),this._zoomImage(),this.canvas.renderAll()},_calculateImagePosition:function(){this.image.set({left:this.editorWidth/2,top:this.editorHeight/2})},_createViewportMask:function(){this.viewportMask=new fabric.Rect({width:this.image.width,height:this.image.height,fill:"rgba(127,0,0,1)",originX:"center",originY:"center",globalCompositeOperation:"destination-in",left:this.image.left,top:this.image.top}),this.canvas.add(this.viewportMask),this.canvas.renderAll()},_calculateViewportMask:function(){if(this.viewportMask){var a={};a="crop"==this.currentView?{width:this.editorWidth,height:this.editorHeight}:this.getScaledImageDimensions(),this.viewportMask.set($.extend({},a,{left:this.editorWidth/2,top:this.editorHeight/2})),this.canvas.renderAll()}},hasOrientationChanged:function(){return this.viewportRotation%180!=0},getScaledImageDimensions:function(){var a=this.originalHeight/this.originalWidth,b=this.editorHeight/this.editorWidth,c={};return this.hasOrientationChanged()?(a=1/a,a>b?(c.width=this.editorHeight,c.height=Math.round(this.originalHeight*(this.editorHeight/this.originalWidth))):(c.height=this.editorWidth,c.width=Math.round(this.originalWidth/(this.originalHeight/this.editorWidth)))):a>b?(c.height=this.editorHeight,c.width=Math.round(this.originalWidth/(this.originalHeight/this.editorHeight))):(c.width=this.editorWidth,c.height=Math.round(this.originalHeight*(this.editorWidth/this.originalWidth))),c},_zoomImage:function(){var a=this.getScaledImageDimensions();this.image.set({width:a.width*this.zoomRatio,height:a.height*this.zoomRatio})},_addControlListeners:function(){this.addListener(this.$tabs,"click","_handleTabClick"),this.addListener($(".rotate-left"),"click",function(a){this.rotateImage(-90)}.bind(this)),this.addListener($(".rotate-right"),"click",function(a){this.rotateImage(90)}.bind(this)),this.addListener($(".flip-vertical"),"click",function(a){this.flipImage("y")}.bind(this)),this.addListener($(".flip-horizontal"),"click",function(a){this.flipImage("x")}.bind(this)),this.addListener(Garnish.$doc,"keydown",function(a){a.keyCode==Garnish.SHIFT_KEY&&(this.lockAspectRatio=!0)}.bind(this)),this.addListener(Garnish.$doc,"keyup",function(a){a.keyCode==Garnish.SHIFT_KEY&&(this.lockAspectRatio=!1)}.bind(this))},_handleTabClick:function(a){if(!this.animationInProgress){var b=$(a.currentTarget),c=b.data("view");this.$tabs.removeClass("selected"),b.addClass("selected"),this.showView(c)}},showView:function(a){this.$views.addClass("hidden");var b=this.$views.filter('[data-view="'+a+'"]');b.removeClass("hidden"),"rotate"==a?this.enableSlider():this.disableSlider(),"crop"==this.currentView&&"crop"!=a?this.disableCropMode():"crop"!=this.currentView&&"crop"==a?(this.updateSizeAndPosition(),this.enableCropMode()):this.updateSizeAndPosition(),this.currentView=a},rotateImage:function(a){if(!this.animationInProgress){if(a%90!=0)return!1;this.animationInProgress=!0,this.viewportRotation+=a,this.viewportRotation=parseInt((this.viewportRotation+360)%360,10);var b=this.getScaledImageDimensions(),c=this.image.getAngle()+a;this.viewportMask.animate({angle:this.viewportRotation},{duration:this.settings.animationDuration}),this.image.animate({angle:c,width:b.width,height:b.height},{onChange:this.canvas.renderAll.bind(this.canvas),duration:this.settings.animationDuration,onComplete:function(){var a=parseInt((this.image.getAngle()+360)%360,10);this.image.set({angle:a}),this.animationInProgress=!1,this._repositionImage()}.bind(this)})}},flipImage:function(a){if(!this.animationInProgress){this.animationInProgress=!0,this.hasOrientationChanged()&&(a="y"==a?"x":"y");var b={};if("y"==a)var b={scaleY:this.image.scaleY*-1};else var b={scaleX:this.image.scaleX*-1};this.image.animate(b,{onChange:this.canvas.renderAll.bind(this.canvas),duration:this.settings.animationDuration,onComplete:function(){this.animationInProgress=!1,this._repositionImage()}.bind(this)})}},straighten:function(a){this.animationInProgress||(this.animationInProgress=!0,this.imageStraightenAngle=parseInt(a.value,10)%360,this.image.set({angle:this.viewportRotation+this.imageStraightenAngle}),this.zoomRatio=this.getZoomToCoverRatio(this.getScaledImageDimensions()),this._zoomImage(),this.canvas.renderAll(),this.animationInProgress=!1)},resetStraighten:function(a){this.animationInProgress||(this.$straighten.val(0),this.straighten())},saveImage:function(a){if($button=$(a.currentTarget),$button.hasClass("disabled"))return!1;$(".btn",this.$buttons).addClass("disabled"),this.$buttons.append('<div class="spinner"></div>');var b={assetId:this.assetId,viewportRotation:this.viewportRotation,imageRotation:this.imageStraightenAngle,replace:$button.hasClass("replace")?1:0},c=this.appliedFilter;if(c){b.filter=c;var d=this.appliedFilterOptions;for(var e in d)b["filterOptions["+e+"]"]=encodeURIComponent(d[e])}this.isCroppingPerformed&&(b.cropData=this.cropData),Craft.postActionRequest("assets/save-image",b,function(a){this.$buttons.find(".btn").removeClass("disabled").end().find(".spinner").remove(),this.onSave()}.bind(this))},getZoomToCoverRatio:function(a){var b=Math.abs(this.imageStraightenAngle)*(Math.PI/180),c=Math.sin(b)*a.height+Math.cos(b)*a.width,d=Math.sin(b)*a.width+Math.cos(b)*a.height;return Math.max(c/a.width,d/a.height)},getZoomToFitRatio:function(a){boundingBox=this._getImageBoundingBox(a);var b=1;if(boundingBox.height>this.editorHeight||boundingBox.width>this.editorWidth){var c=this.editorHeight/boundingBox.height,d=this.editorWidth/boundingBox.width;b=Math.min(d,c)}return b},getCombinedZoomRatio:function(a){return this.getZoomToCoverRatio(a)/this.getZoomToFitRatio(a)},_showGrid:function(){if(!this.grid){for(var a={strokeWidth:1,stroke:"rgba(255,255,255,0.5)"},b=8,c=this.viewportMask.width,d=this.viewportMask.height,e=c/(b+1),f=d/(b+1),g=[new fabric.Rect({strokeWidth:2,stroke:"rgba(255,255,255,1)",originX:"center",originY:"center",width:c,height:d,left:c/2,top:d/2,fill:"rgba(255,255,255,0)"})],h=1;h<=b;h++)g.push(new fabric.Line([h*e,0,h*e,d],a));for(var h=1;h<=b;h++)g.push(new fabric.Line([0,h*f,c,h*f],a));this.grid=new fabric.Group(g,{left:this.editorWidth/2,top:this.editorHeight/2,originX:"center",originY:"center",angle:this.viewportMask.angle}),this.canvas.add(this.grid),this.canvas.renderAll()}},_hideGrid:function(){this.canvas.remove(this.grid),this.grid=null,this.canvas.renderAll()},onFadeOut:function(){this.destroy()},applyFilter:function(a){if($button=$(a.currentTarget),$button.hasClass("disabled"))return!1;$button.addClass("disabled"),$spinner=$('<div class="spinner filter-spinner"></div>').insertAfter($button);var b={assetId:this.assetId,size:this.settings.assetSize},c=this.getSelectedFilter();if(c){var d=this.getFilterOptions(c);if(c==this.appliedFilter&&JSON.stringify(this.appliedFilterOptions)==JSON.stringify(d))return $spinner.remove(),void $button.removeClass("disabled");this.appliedFilter=c,this.appliedFilterOptions=d,b.filter=c;for(var e in d)b["filterOptions["+e+"]"]=encodeURIComponent(d[e])}else{if(null==this.appliedFilter)return $spinner.remove(),void $button.removeClass("disabled");this.appliedFilterOptions={},this.appliedFilter=null}imageUrl=Craft.getActionUrl("assets/edit-image",b),this.image.setSrc(imageUrl,$.proxy(function(a){this._repositionImage(),this._prepareImageForRotation(),$spinner.remove(),$button.removeClass("disabled")},this))},getSelectedFilter:function(){return $(".filter-select",this.$tools).find("option:selected").val()},getFilterOptions:function(a){var b={};return $filterFields=$(".filter-fields[filter="+a+"]").find("input, select, textarea"),$filterFields.each(function(){$input=$(this),b[$input.prop("name")]=encodeURIComponent($input.val())}),b},show:function(){this.base(),$("html").addClass("noscroll")},hide:function(){this.removeAllListeners(),this.straighteningInput.removeAllListeners(),$("html").removeClass("noscroll"),this.base()},onSave:function(){this.settings.onSave()},isActiveControl:function(a){return 0==a.parents(".disabled").length},enableSlider:function(){this.$imageTools.removeClass("hidden")},disableSlider:function(){this.$imageTools.addClass("hidden")},enableCropMode:function(){this._setImageMode("crop")},disableCropMode:function(){this._setImageMode("regular")},_setImageMode:function(a){if(!this.animationInProgress){this.animationInProgress=!0;var b=this.getScaledImageDimensions(),c=$.extend({},b);if("crop"==a){this.zoomRatio=this.getZoomToFitRatio(b),c={width:this.editorWidth,height:this.editorHeight};var d=function(){this._setImageVerticeCoordinates(),this._showCropper()}.bind(this)}else{this.zoomRatio=this.getZoomToCoverRatio(b);var d=function(){this.updateSizeAndPosition()}.bind(this)}this.image.animate({width:b.width*this.zoomRatio,height:b.height*this.zoomRatio},{onChange:this.canvas.renderAll.bind(this.canvas),duration:this.settings.animationDuration,onComplete:function(){d(),this.animationInProgress=!1,this.canvas.renderAll()}.bind(this)}),this.viewportMask.animate({width:c.width,height:c.height},{duration:this.settings.animationDuration})}},applyCrop:function(){var a=this.clipper.width,b=this.clipper.height,c={x:this.clipper.left+a/2+2,y:this.clipper.top+b/2+2},d=c.x-this.editorWidth/2,e=c.y-this.editorHeight/2;this.viewportMask.animate({width:a,height:b},{duration:this.settings.animationDuration}),this.image.animate({left:this.image.left-d,top:this.image.top-e},{onComplete:function(){$(".rotation-tools, .filter-tools",this.$tools).removeClass("disabled"),$(".cropping-tools .crop-mode-enabled",this.$tools).addClass("hidden"),$(".cropping-tools .crop-mode-disabled",this.$tools).removeClass("hidden")}.bind(this),onChange:this.canvas.renderAll.bind(this.canvas),duration:this.settings.animationDuration}),this.hideCropper();var f,g;if(0==this.imageStraightenAngle)var f=Math.round((this.editorWidth-this.image.width)/2),g=Math.round((this.editorHeight-this.image.height)/2);else var f=0,g=0;this.cropData={width:this.clipper.width,height:this.clipper.height,cornerLeft:Math.max(Math.round(this.clipper.left-f-this.imageVerticeCoords.c.x),0),cornerTop:Math.max(Math.round(this.clipper.top-g-this.imageVerticeCoords.d.y),0),scaledWidth:this.image.width,scaledHeight:this.image.height,zoomRatio:this.getZoomToFitRatio()},this.isCroppingPerformed=!0},_showCropper:function(){this._drawCropper(),this._calculateCropperBoundaries(),this.addListener(this.$croppingCanvas,"mousemove",this._handleMouseMove.bind(this)),this.addListener(this.$croppingCanvas,"mousedown",this._handleMouseDown.bind(this)),this.addListener(this.$croppingCanvas,"mouseup",this._handleMouseUp.bind(this))},hideCropper:function(){this.clipper&&(this.croppingCanvas.remove(this.clipper),this.croppingCanvas.remove(this.croppingShade),this.croppingCanvas.remove(this.cropperHandles),this.croppingCanvas.remove(this.croppingRectangle),this.croppingCanvas.off({"mouse:down":this._handleMouseDown.bind(this),"mouse:move":this._handleMouseMove.bind(this),"mouse:up":this._handleMouseUp.bind(this)}))},_drawCropper:function(){this.croppingCanvas=new fabric.StaticCanvas("cropping-canvas",{backgroundColor:"rgba(0,0,0,0)",hoverCursor:"default",selection:!1}),this.$croppingCanvas=$("#cropping-canvas",this.$editorContainer),this.croppingCanvas.setDimensions({width:this.editorWidth,height:this.editorHeight}),$("#cropping-canvas",this.$editorContainer).css({position:"absolute",top:0,left:0}),this.croppingShade=new fabric.Rect({left:this.editorWidth/2,top:this.editorHeight/2,originX:"center",originY:"center",width:this.editorWidth,height:this.editorHeight,fill:"rgba(0,0,0,0.4)"}),this.croppingShade.set({hasBorders:!1,hasControls:!1,selectable:!1});var a=this.getScaledImageDimensions(),b=0==this.imageStraightenAngle?1.2:1.2*this.getCombinedZoomRatio(a),c=a.width/b,d=a.height/b;this.clipper=new fabric.Rect({left:Math.floor(this.editorWidth/2),top:Math.floor(this.editorHeight/2),originX:"center",originY:"center",width:c,height:d,stroke:"black",fill:"rgba(128,0,0,1)",strokeWidth:0,hasBorders:!1,hasControls:!1,selectable:!1}),this.clipper.globalCompositeOperation="destination-out",this.croppingCanvas.add(this.croppingShade),this.croppingCanvas.add(this.clipper)},_calculateCropperBoundaries:function(a){if(a||!this.cropperHandles){this.cropperHandles&&(this.croppingCanvas.remove(this.cropperHandles),this.croppingCanvas.remove(this.croppingRectangle));var b={strokeWidth:2,stroke:"rgb(255,255,255)",fill:!1},c=[],d=new fabric.Path("M 0,10 L 0,0 L 10,0");d.set(b),c.push(d);var d=new fabric.Path("M "+(this.clipper.width-8)+",0 L "+(this.clipper.width+4)+",0 L "+(this.clipper.width+4)+",10");d.set(b),c.push(d);var d=new fabric.Path("M "+(this.clipper.width+4)+","+(this.clipper.height-8)+" L"+(this.clipper.width+4)+","+(this.clipper.height+4)+" L "+(this.clipper.width-8)+","+(this.clipper.height+4));d.set(b),c.push(d);var d=new fabric.Path("M 10,"+(this.clipper.height+4)+" L 0,"+(this.clipper.height+4)+" L 0,"+(this.clipper.height-8));d.set(b),c.push(d),this.cropperHandles=new fabric.Group(c,{left:this.clipper.left,top:this.clipper.top,originX:"center",originY:"center",hasBorders:!1,hasControls:!1,selectable:!1}),this.croppingRectangle=new fabric.Rect({left:this.clipper.left,top:this.clipper.top,width:this.clipper.width,height:this.clipper.height,fill:"rgba(0,0,0,0)",stroke:"rgba(255,255,255,0.8)",strokeWidth:2,hasBorders:!1,hasControls:!1,selectable:!1,originX:"center",originY:"center"}),this.croppingCanvas.add(this.cropperHandles),this.croppingCanvas.add(this.croppingRectangle)}else this.cropperHandles.set({left:this.clipper.left,top:this.clipper.top}),this.croppingRectangle.set({left:this.clipper.left,top:this.clipper.top});this.croppingCanvas.renderAll()},_handleMouseDown:function(a){var b=this._cropperHandleHitTest(a),c=this._cropperHitTest(a);(b||c)&&(this.previousMouseX=a.pageX,this.previousMouseY=a.pageY,b?this.scalingCropper=b:c&&(this.draggingCropper=!0))},_handleMouseMove:function(a){this.draggingCropper||this.scalingCropper?(this.draggingCropper?this._handleCropperDrag(a):this._handleCropperScale(a),this.previousMouseX=a.pageX,this.previousMouseY=a.pageY,this._calculateCropperBoundaries(this.scalingCropper),this.croppingCanvas.renderAll()):this._setMouseCursor(a)},_handleMouseUp:function(a){this.draggingCropper=!1,this.scalingCropper=!1},_handleCropperDrag:function(a){var b=a.pageX-this.previousMouseX,c=a.pageY-this.previousMouseY;if(0!=b||0!=c){var d={left:this.clipper.left-this.clipper.width/2,top:this.clipper.top-this.clipper.height/2,width:this.clipper.width,height:this.clipper.height},e=this._getRectangleVertices(d,b,c);this.arePointsInsideRectangle(e,this.imageVerticeCoords)&&this.clipper.set({left:this.clipper.left+b,top:this.clipper.top+c})}},_handleCropperScale:function(a){var b=a.pageX-this.previousMouseX,c=a.pageY-this.previousMouseY;if(0!=b||0!=c){if(this.lockAspectRatio&&("tl"==this.scalingCropper||"tr"==this.scalingCropper||"bl"==this.scalingCropper||"br"==this.scalingCropper))if(Math.abs(b)>Math.abs(c)){var d=this.clipper.width/this.clipper.height;c=b/d,c*="tr"==this.scalingCropper||"bl"==this.scalingCropper?-1:1}else{var d=this.clipper.width/this.clipper.height;b=c*d,b*="tr"==this.scalingCropper||"bl"==this.scalingCropper?-1:1}var e={left:this.clipper.left-this.clipper.width/2,top:this.clipper.top-this.clipper.height/2,width:this.clipper.width,height:this.clipper.height};switch(this.scalingCropper){case"t":e.top+=c,e.height-=c;break;case"b":e.height+=c;break;case"l":e.left+=b,e.width-=b;break;case"r":e.width+=b;break;case"tl":e.top+=c,e.height-=c,e.left+=b,e.width-=b;break;case"tr":e.top+=c,e.height-=c,e.width+=b;break;case"bl":e.height+=c,e.left+=b,e.width-=b;break;case"br":e.height+=c,e.width+=b}if(!(e.height<30||e.width<30)){var f=this._getRectangleVertices(e);this.arePointsInsideRectangle(f,this.imageVerticeCoords)&&(this.clipper.set({top:e.top+e.height/2,left:e.left+e.width/2,width:e.width,height:e.height}),this._calculateCropperBoundaries(),this.croppingCanvas.renderAll())}}},_setMouseCursor:function(a){var b="default",c=this._cropperHandleHitTest(a);c?"t"==c||"b"==c?b="ns-resize":"l"==c||"r"==c?b="ew-resize":"tl"==c||"br"==c?b="nwse-resize":"bl"!=c&&"tr"!=c||(b="nesw-resize"):this._cropperHitTest(a)&&(b="move"),$(".body").css("cursor",b)},_cropperHandleHitTest:function(a){var b=this.$croppingCanvas.offset(),c=a.pageX-b.left,d=a.pageY-b.top,e=this.clipper.left-this.clipper.width/2,f=e+this.clipper.width,g=this.clipper.top-this.clipper.height/2,h=g+this.clipper.height;if(c<e+10&&c>e-3){if(d<g+10&&d>g-3)return"tl";if(d<h+3&&d>h-10)return"bl"}if(c>f-13&&c<f+3){if(d<g+10&&d>g-3)return"tr";if(d<h+2&&d>h-10)return"br"}return c<e+3&&c>e-3&&d<h-10&&d>g+10?"l":c<f+1&&c>f-5&&d<h-10&&d>g+10?"r":d<g+4&&d>g-2&&c>e+10&&c<f-10?"t":d<h+2&&d>h-4&&c>e+10&&c<f-10&&"b"},_cropperHitTest:function(a){var b=this.$croppingCanvas.offset(),c=a.pageX-b.left,d=a.pageY-b.top,e=this.clipper.left-this.clipper.width/2,f=e+this.clipper.width,g=this.clipper.top-this.clipper.height/2,h=g+this.clipper.height;return c>=e&&c<=f&&d>=g&&d<=h},_getRectangleVertices:function(a,b,c){"undefined"==typeof b&&(b=0),"undefined"==typeof c&&(c=0);var d={x:a.left+b,y:a.top+c},e={x:d.x+a.width,y:d.y},f={x:e.x,y:e.y+a.height},g={x:d.x,y:f.y};return[d,e,f,g]},_setImageVerticeCoordinates:function(){var a=-1*this.imageStraightenAngle*(Math.PI/180),b=this.getScaledImageDimensions(),c=this.getZoomToFitRatio(b),d=b.height*c,e=b.width*c,f=Math.cos(a)*d,g=Math.sin(a)*e,h=Math.cos(a)*e,i=Math.sin(a)*d,j=(this.editorHeight-(f+g))/2,k=(this.editorWidth-(i+h))/2;this.imageVerticeCoords={a:{x:k+h,y:j},b:{x:this.editorWidth-k,y:j+f},c:{x:k+i,y:this.editorHeight-j},d:{x:k,y:j+g}},this.canvas.renderAll()},_destroyCropper:function(){this.clipper=null,this.cropperHandles=null,this.croppingRectangle=null,this.croppingShade=null,this.croppingCanvas=null,$("#cropping-canvas").siblings(".upper-canvas").remove(),$("#cropping-canvas").parent(".canvas-container").before($("#cropping-canvas")),$(".canvas-container").remove()},_debug:function(a){this.canvas.remove(this.debugger),this.debugger=a,this.canvas.add(this.debugger)},arePointsInsideRectangle:function(a,b){for(var c=this._getVector(b.a,b.b),d=this._getVector(b.b,b.c),e=this._getScalarProduct(c,c),f=this._getScalarProduct(d,d),g=0;g<a.length;g++){var h=a[g],i=this._getVector(b.a,h),j=this._getVector(b.b,h),k=this._getScalarProduct(c,i),l=this._getScalarProduct(d,j),m=0<=k&&k<=e,n=0<=l&&l<=f;if(!m||!n)return!1}return!0},_getVector:function(a,b){return{x:b.x-a.x,y:b.y-a.y}},_getScalarProduct:function(a,b){return a.x*b.x+a.y*b.y},_getMagnitude:function(a){return Math.sqrt(a.x*a.x+a.y*a.y)},_getImageBoundingBox:function(a){var b={},c=Math.abs(this.imageStraightenAngle)*(Math.PI/180),d=a.height/a.width;if(b.height=a.width*(Math.sin(c)+Math.cos(c)*d),b.width=a.width*(Math.cos(c)+Math.sin(c)*d),this.hasOrientationChanged()){var e=b.width;b.width=b.height,b.height=e}return b}},{defaults:{animationDuration:100,allowSavingAsNew:!0,onSave:$.noop}});
//# sourceMappingURL=AssetImageEditor.js.map