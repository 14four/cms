--- /Users/brandon/git/Blocks/Source/Core/blocks/app/services/EmailService.php	2012-08-16 15:47:28.000000000 -0700
+++ /Users/brandon/git/Blocks/Source/BlocksPro/blocks/app/services/EmailService.php	2012-08-17 16:41:36.000000000 -0700
@@ -9,6 +9,106 @@
 	private $_defaultEmailTimeout = 10;
 
 	/**
+	 * Returns all of the system email messages.
+	 *
+	 * @return array
+	 */
+	public function getAllMessages()
+	{
+		$messages = EmailMessage::model()->findAll();
+		return $messages;
+	}
+
+	/**
+	 * Returns a system email message by its ID.
+	 *
+	 * @param int $messageId
+	 * @return EmailMessage
+	 */
+	public function getMessageById($messageId)
+	{
+		$message = EmailMessage::model()->findById($messageId);
+		return $message;
+	}
+
+	/**
+	 * Returns a system email message by its key.
+	 *
+	 * @param string $key
+	 * @return EmailMessage
+	 */
+	public function getMessageByKey($key)
+	{
+		$message = EmailMessage::model()->findByAttributes(array(
+			'key' => $key
+		));
+		return $message;
+	}
+
+	/**
+	 * Registers a new system email message.
+	 *
+	 * @param string $key
+	 * @return EmailMessage
+	 */
+	public function registerMessage($key)
+	{
+		$message = new EmailMessage();
+		$message->key = $key;
+		$message->save();
+		return $message;
+	}
+
+	/**
+	 * Returns the localized content for a system email message.
+	 *
+	 * @param int $messageId
+	 * @param string $language
+	 * @return string
+	 */
+	public function getMessageContent($messageId, $language = null)
+	{
+		if (!$language)
+			$language = blx()->language;
+
+		$content = EmailMessageContent::model()->findByAttributes(array(
+			'message_id' => $messageId,
+			'language' => $language
+		));
+
+		if (!$content)
+		{
+			$content = new EmailMessageContent();
+			$content->message_id = $messageId;
+			$content->language = ($language ? $language : blx()->language);
+		}
+
+		return $content;
+	}
+
+	/**
+	 * Saves the localized content for a system email message.
+	 *
+	 * @param int $messageId
+	 * @param string $subject
+	 * @param string $body
+	 * @param string $htmlBody
+	 * @param string $language
+	 */
+	public function saveMessageContent($messageId, $subject, $body, $htmlBody = null, $language = null)
+	{
+		// Has this message already been translated into this language?
+		$content = $this->getMessageContent($messageId, $language);
+
+		$content->subject = $subject;
+		$content->body = $body;
+		$content->html_body = $htmlBody;
+		$content->save();
+
+		return $content;
+	}
+
+	/**
 	 * Sends an email.
 	 *
 	 * @param User $user
@@ -114,6 +214,52 @@
 	 */
 	public function sendEmailByKey(User $user, $key, $pluginId = null, $variables = array())
 	{
+		// Get the email by key from the database.
+		$message = $this->getMessageByKey($key);
+
+		if (!$message)
+			throw new Exception(Blocks::t('Could not find an email template with the key “{key}”', array('key' => $key)));
+
+		// Get the content
+		$content = $this->getMessageContent($message->id, $user->preferred_language);
+
+		// Come up with our own HTML body content if it's not already supplied
+		if (!$content->html_body)
+		{
+			if (!class_exists('\Markdown_Parser', false))
+				require_once blx()->path->getFrameworkPath().'vendors/markdown/markdown.php';
+
+			$md = new \Markdown_Parser();
+			$content->html_body = $md->transform($content->body);
+		}
+
+		if ($message->template)
+		{
+			$tempTemplatesPath = blx()->path->getSiteTemplatesPath();
+			$template = $message->template;
+		}
+		else
+		{
+			$tempTemplatesPath = blx()->path->getAppTemplatesPath();
+			$template = '_special/email';
+		}
+
+		$htmlBody = "{% extends '".$template."' %}\n" .
+			"{% block body %}\n" .
+			$content->html_body .
+			"{% endblock %}\n";
+
+		// Temporarily swap the templates path
+		$originalTemplatesPath = blx()->path->getTemplatesPath();
+		blx()->path->setTemplatesPath($tempTemplatesPath);
+
+		// Send the email
+		$return = $this->sendEmail($user, $content->subject, $content->body, $htmlBody, $variables);
+
+		// Return to the original templates path
+		blx()->path->setTemplatesPath($originalTemplatesPath);
+
+		return $return;
 	}
 
 	/**
