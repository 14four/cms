{#
    Shows a revision menu for an element
#}

{% import "_includes/forms" as forms %}

{% set drafts = element.find()
    .draftOf(element)
    .siteId(element.siteId)
    .anyStatus()
    .all() %}

{% set revisions = element.find()
    .revisionOf(element.sourceId)
    .siteId(element.siteId)
    .anyStatus()
    .offset(1)
    .limit(10)
    .orderBy('num desc')
    .all() %}

{% set baseUrl = element.getCpEditUrl() %}
{% set baseUrl = "entries/#{sectionHandle}/#{craft.app.request.getSegment(3)}/" %}
{% set baseParams = craft.app.request.queryParams|withoutKey(craft.app.config.general.pathParam)|withoutKey('draftId')|withoutKey('revisionId')|withoutKey('siteId') %}
{% set supportedSites = craft.app.isMultiSite ? element.supportedSites : [element.site] %}
{% set isMultiSiteElement = supportedSites|length > 1 %}
{% set baseUrl = element.getCpEditUrl() %}

<div class="btngroup">
    <div id="revision-btn" class="btn menubtn"{% if showSiteLabel %} data-icon="world"{% endif %}>{{ revisionLabel }}</div>

    <div class="menu">
        {% if isMultiSiteElement %}
            {% set siteGroups = craft.app.sites.getAllGroups() %}
            {% for group in siteGroups %}
                {% set groupSiteIds = group.getSiteIds()|intersect(siteIds) %}
                {% if groupSiteIds %}
                    {% if siteGroups|length > 1 %}<h6>{{ group.name|t('site') }}</h6>{% endif %}
                    <ul class="padded">
                        {% for siteId in groupSiteIds %}
                            {% set site = craft.app.sites.getSiteById(siteId) %}
                            {% set status = siteId in enabledSiteIds ? 'enabled' : 'disabled' %}
                            <li>
                                {% if siteId == element.siteId %}
                                    <a class="sel">
                                        <div class="status {{ status }}"></div>{{ site.name|t('site') }}
                                    </a>
                                {% else %}
                                    {% set url = url(baseUrl, baseParams|merge({ site: site.handle })) %}
                                    <a href="{{ url }}">
                                        <div class="status {{ status }}"></div>{{ site.name|t('site') }}
                                    </a>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}
            {% endfor %}
        {% endif %}

        {% if isMultiSiteElement %}
            <hr>
        {% endif %}

        <ul class="padded">
            {% set currentRevisionEditTime = element.currentRevision.dateCreated ?? element.dateUpdated %}
            <li>
                <a{% if not element.draftId and not element.revisionId %} class="sel"{% endif %} href="{{ baseUrl }}">{{ "Current"|t('app') }}
                    <span class="light">{{ currentRevisionEditTime|timestamp('short') }}
                        {%- if element.currentRevision %}, {{ element.currentRevision.creator }}{% endif %}
                    </span>
                </a>
            </li>
        </ul>

        {% if drafts %}
            <h6>{{ "Drafts"|t('app') }}</h6>
            <ul class="padded">
                {% for draft in drafts %}
                    {% set url = url(baseUrl, baseParams|merge({ draftId: draft.draftId })) %}
                    <li>
                        <a{% if draft.draftId == element.draftId %} class="sel"{% endif %} href="{{ url }}">
                            {{ draft.draftName }}
                            <span class="light">{{ "by {creator}"|t('app', { creator: draft.creator }) }}</span>
                        </a>
                    </li>
                {% endfor %}
            </ul>
        {% endif %}

        {% if revisions %}
            <h6>{{ "Recent Revisions"|t('app') }}</h6>
            <ul class="padded">
                {% for revision in revisions %}
                    <li>
                        {% set url = url(baseUrl, baseParams|merge({ revisionId: revision.revisionId })) %}
                        <a{% if revision.revisionId == element.revisionId %} class="sel"{% endif %} href="{{ url }}">
                            {{ "Revision {num}"|t('app', { num: revision.revisionNum }) }}
                            <span class="light">{{ revision.dateCreated|timestamp('short') }}, {{ revision.getCreator() }}</span>
                        </a>
                    </li>
                {% endfor %}
            </ul>
        {% endif %}
    </div>

    {% if element.draftId %}
        {% do craft.app.session.authorize('editDraft:' ~ element.draftId) %}
        <a id="editdraft-btn" class="btn edit icon" title="{{ 'Edit Draft Settings'|t('app') }}"></a>
        {% js %}
        new Craft.DraftEditor({{ element.draftId }}, '{{ element.draftName|e("js") }}', '{{ element.draftNotes|e("js") }}');
    {% endjs %}
        {% do view.registerTranslations('app', [
            "Draft Name",
            "Notes",
        ]) %}
    {% endif %}
</div>
