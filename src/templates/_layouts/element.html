{#
    "Edit Element" layout template

    The following variables should be defined by the sub-template:

    - element: the source element or one of its drafts/revisions
    - previewContexts (optional): additional locations that should be available for previewing the element
    - canDeleteDraft (optional): whether the current user is allowed to delete the draft (if it is one).
      If the current user created the draft, then it will be deletable regardless.
    - canUpdateSource (optional): whether the current user is allowed to update the source element
      (e.g. by publishing a draft or reverting the element to a prior revision).
    - showPreviewButn (optional): whether Live Preview should be enabled.
    - shareUrl (optional): the URL that the Share button should link to.
    - saveDraftAction: the controller action that should be used to save a draft
    - deleteDraftAction: the controller action that should be used to delete a draft
    - applyDraftAction: the controller action that should be used to apply a draft onto the source element
    - revertSourceAction: the controller action that should be used to revert the source element to a revision
#}

{% extends '_layouts/cp' %}

{% set source = element.draftId or element.revisionId ? element.source : element %}
{% set previewContexts = previewContexts ?? [] %}
{% if source.uri %}
    {% set previewContexts = [{
        label: 'Primary {type} page'|t('app', { type: element.displayName()|lower }),
        url: element.uri
    }]|merge(previewContexts) %}
{% endif %}
{% set enablePreview = previewContexts and not craft.app.request.isMobileBrowser(true) %}

{% set canDeleteDraft = element.draftId and ((canDeleteDraft ?? false) or element.creatorId == currentUser.id) %}
{% set canUpdateSource = canUpdateSource ?? false %}
{% set shareUrl = shareUrl ?? null %}
{% set revertSourceAction = revertSourceAction ?? null %}

{% if canUpdateSource and not element.revisionId %}
    {% set fullPageForm = true %}
{% endif %}

{% if element.draftId %}
    {% do craft.app.session.authorize('previewDraft:' ~ element.draftId) %}
{% elseif not element.revisionId %}
    {% do craft.app.session.authorize('previewElement:' ~ element.id) %}
{% endif %}

{% block header %}
    {{ block('pageTitle') }}
    {{ block('contextMenu') }}
    <div class="flex-grow"></div>
    {% if not element.revisionId and previewContexts %}
        <div class="btngroup">
            {% if enablePreview %}
                <div id="preview-btn" class="btn">{{ "Preview"|t('app') }}</div>
            {% endif %}
            <div id="share-btn" class="btn">{{ 'Share'|t('app') }}</div>
        </div>
    {% endif %}
    {{ block('actionButton') }}
{% endblock %}

{% block contextMenu %}
    {% include "_includes/revisionmenu" %}
{% endblock %}

{% block actionButton %}
    {% if canUpdateSource %}
        {% if element.revisionId and revertSourceAction %}
            <div class="spacer"></div>
            <form method="post" accept-charset="UTF-8">
                {{ csrfInput() }}
                <input type="hidden" name="action" value="{{ revertSourceAction }}">
                {{ redirectInput(element.cpEditUrl) }}
                <input type="hidden" name="revisionId" value="{{ element.revisionId }}">
                <div class="secondary-buttons">
                    <input type="button" class="btn submit formsubmit" value="{{ 'Revert {type} to this revision'|t('app', { type: element.displayName()|lower }) }}">
                </div>
            </form>
        {% else %}
            <div class="spacer"></div>
            <input type="submit" id="apply-btn" class="btn submit{% if not element.draftId %} disabled{% endif %}" value="{{ 'Update {type}'|t('app', { type: element.displayName()|lower }) }}">
        {% endif %}
    {% endif %}
{% endblock %}

{% block main %}
    {% if canUpdateSource and craft.app.isMultiSite %}
        <input type="hidden" name="siteId" value="{{ element.siteId }}">
    {% endif %}
    {{ parent() }}
{% endblock %}

{% if not element.revisionId %}
    {% set normalizedPreviewContexts = [] %}
    {% set scheme = craft.app.request.isSecureConnection ? 'https': null %}
    {% for context in previewContexts %}
        {% set path = context.url ?? view.renderObjectTemplate(context.urlFormat, element) %}
        {% set normalizedPreviewContexts = normalizedPreviewContexts|merge([{
            label: context.label|t('site'),
            url: siteUrl(path, scheme=scheme, siteId=element.siteId)
        }]) %}
    {% endfor %}

    {% set settings = {
        elementType: className(element),
        sourceId: element.sourceId,
        siteId: element.siteId,
        isLive: not element.draftId and not element.revisionId and element.enabled and element.enabledForSite,
        sourceEditUrl: element.cpEditUrl,
        draftId: element.draftId,
        draftName: element.draftId ? element.draftName : null,
        draftNotes: element.draftId ? element.draftNotes : null,
        canDeleteDraft: canDeleteDraft,
        canUpdateSource: canUpdateSource,
        saveDraftAction: saveDraftAction,
        deleteDraftAction: deleteDraftAction,
        applyDraftAction: applyDraftAction,
        enablePreview: enablePreview,
        previewContexts: normalizedPreviewContexts,
    } %}
    {% js %}
        new Craft.DraftEditor({{ settings|json_encode|raw }});
    {% endjs %}
{% endif %}
