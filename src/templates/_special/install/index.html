{% layout "_layouts/basic" %}

{% region "title" %}Install Blocks{% endregion %}

{% region "styles" %}
	{{ cp.resource('app/styles/cp.css').css }}
	{{ cp.resource('app/styles/install.css').css }}
{% endregion %}

{% region "body" %}
	<div class="install-container">
		<div id="install-btn" class="btn big submit">
			<span class="label">Install Blocks</span>
		</div>
	</div>
{% endregion %}

{% region "scripts" %}
	<script type="text/javascript">

		var $btn = $('#install-btn'),
			$btnLabel = $btn.find('.label');

		function updateBtnLabel($newBtnLabel, callback)
		{
			$btn.width($btn.width());
			$newBtnLabel.appendTo($btn);
			$btnLabel.show().fadeOut('fast');
			$newBtnLabel.hide().delay('fast').fadeIn('fast');
			$btn.animate({ width: $newBtnLabel.outerWidth() + 24 }, function() {
				$btnLabel.remove();
				$btnLabel = $newBtnLabel;
				if (typeof callback == 'function')
					callback();
			});
		}

		function displayError(error)
		{
			var $newBtnLabel = $('<span class="label iconlabel error">'+error+'</span>');
			updateBtnLabel($newBtnLabel);
		}

		function runInstaller()
		{
			// Run the ajax request
			$.post('{{ url.generateUrl("install/install") }}', function(data, textStatus, jqXHR) {
				if (textStatus != 'success' || !(data.error || data.success))
					displayError('An unknown error occurred.');
				else if (data.error)
					displayError(data.error);
				else
				{
					var $newBtnLabel = $('<span class="label iconlabel success">Installed!</span>');
					updateBtnLabel($newBtnLabel, function() {
						// Redirect to the dashboard
						setTimeout(function() {
							window.location = '{{ url.generateUrl("setup") }}'
						}, 1000);
					});
				}
			});
		}

		$btn.on('click.install', function() {
			// Prevent double-clicks
			$btn.off('click.install');

			$btn.removeClass('submit').addClass('sel');

			var $newBtnLabel = $('<span class="label iconlabel installing">Installing Blocksâ€¦</span>');
			updateBtnLabel($newBtnLabel, runInstaller)
		});

	</script>
{% endregion %}
