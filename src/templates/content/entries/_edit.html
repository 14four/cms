{% extends "_layouts/cp" %}
{% set centered = true %}
{% includeCssResource "css/entry.css" %}
{% includeJsResource "lib/jquery-ui-1.8.23.custom.min.js" %}
{% import "_includes/forms" as forms %}


{% if blx.hasPackage('publishpro') %}
	{% set section = blx.sections.section({ handle: sectionHandle }) %}
	{% if not section %}{% exit 404 %}{% endif %}
{% endif %}


{% if entry is not defined and entryId is defined %}
	{% if draftNum is defined %}
		{% set entry = blx.entryRevisions.getDraftByOffset(entryId, draftNum-1) %}
		{% set revisionLabel = "Draft {num}"|t({ num: draftNum }) %}
	{% elseif versionNum is defined %}
		{% set entry = blx.entryRevisions.getVersionByOffset(entryId, versionNum-1) %}
		{% set revisionLabel = "Version {num}"|t({ num: versionNum }) %}
	{% else %}
		{% set entry = blx.entries.entry({ id: entryId, status: '*' }) %}
		{% set revisionLabel = "Current"|t %}
	{% endif %}

	{% if not entry %}{% exit 404 %}{% endif %}
{% endif %}


{% if blx.hasPackage('publishpro') %}
	{% set blocks = blx.entryBlocks.entryBlocksBySectionId(section.id) %}
{% else %}
	{% set blocks = blx.entryBlocks.entryBlocks %}
{% endif %}


{% set isNewEntry = (entry is not defined or not entry.id) %}


{% if isNewEntry %}
	{% set title = "Create a new entry"|t %}
{% else %}
	{% set title = "Editing “{title}”"|t({ title: entry.title|t }) %}
	{% if entry is defined and entry.classHandle != 'Entry' %}
		{% set title = title ~ ' <span class="version"><span class="hidden">(</span>' ~ revisionLabel ~ '<span class="hidden">)</span></span>' %}
	{% endif %}
{% endif %}


{% set header %}
	<h1>{{ title|raw }}</h1>

	<ul class="left">
		<li><a href="{{ url('content') }}" class="backbtn">{{ "Entries"|t }}</a></li>
	</ul>

	{% if not isNewEntry and blx.hasPackage('publishpro') %}
		<ul class="right">
			<li>
				{% include "content/entries/_revisions" %}
			</li>
		</ul>
	{% endif %}
{% endset %}


{% set tabs %}
	<li><a data-icon="✎" class="active" data-target="entry-content">{{ "Content"|t }}</a></li>
	<li><a data-icon="⚙" data-target="entry-settings">{{ "Settings"|t }}</a></li>
{% endset %}


{% set content %}
	<form method="post" action="">
		{% if blx.hasPackage('publishpro') %}
			<input type="hidden" name="sectionId" value="{{ section.id }}">
		{% endif %}

		{% if not isNewEntry %}
			<input type="hidden" name="entryId" value="{{ entry.id }}">
		{% endif %}

		<div id="entry-content">
			{{ forms.textField({
				label: "Title"|t,
				id: 'title',
				name: 'title',
				value: (entry is defined ? entry.title : null),
				errors: (entry is defined ? entry.getErrors('title') : null),
				required: true
			}) }}

			{% include "_includes/blockfields" with {
				blocks: blocks,
				entity: (entry is defined ? entry : null)
			} only %}
		</div>

		<div id="entry-settings" class="hidden">
			{{ forms.textField({
				label: "Slug"|t,
				id: 'slug',
				name: 'slug',
				value: (entry is defined ? entry.slug : null),
				errors: (entry is defined ? entry.getErrors('slug') : null),
				required: true
			}) }}

			{% if blx.hasPackage('users') %}
				{{ forms.selectField({
					label: "Author"|t,
					id: 'author',
					name: 'author',
					options: blx.users.users,
					value: (entry is defined ? entry.authorId : user.id)
				}) }}
			{% endif %}

			{{ forms.dateField({
				label: "Post Date"|t,
				instructions: "When should the entry go live? (Set automatically if left blank)",
				id: 'postDate',
				name: 'postDate',
				value: (entry is defined and entry.postDate ? entry.postDate.w3cDate : null),
				errors: (entry is defined ? entry.getErrors('postDate') : null)
			}) }}

			{{ forms.dateField({
				label: "Expiration Date"|t,
				instructions: "When should the entry expire?",
				id: 'expiryDate',
				name: 'expiryDate',
				value: (entry is defined and entry.expiryDate ? entry.expiryDate.w3cDate : null),
				errors: (entry is defined ? entry.getErrors('expiryDate') : null)
			}) }}

			{{ forms.textField({
				label: "Tags"|t,
				instructions: "For multiple tags, separate them with a comma.",
				id: 'tags',
				name: 'tags',
				value: (entry is defined ? entry.getTags()|join(', ') : null),
				errors: (entry is defined ? entry.getErrors('tags') : null),
			}) }}

			{% set statusLabel -%}
				{{ "Status:"|t }} <i>{{ isNewEntry ? "Never saved"|t : entry.status|ucfirst|t }}</i>
			{%- endset %}
			{% set statusInput %}
				{{ forms.checkboxField({
					label: "Entry is enabled",
					name: 'enabled',
					checked: (entry is defined ? entry.enabled : true)
				}) }}
			{% endset %}
			{{ forms.field({
				label: statusLabel,
				instructions: "An entry is only “live” if it is enabled, has a Post Date in the past, and an Expiration Date in the future."|t
			}, statusInput) }}
		</div>

		<hr>

		<div class="buttons">
			{% if not isNewEntry and entry.classHandle == 'EntryDraft' %}

				<input type="hidden" name="action" value="entryRevisions/saveDraft">
				<input type="hidden" name="redirect" value="{{ entry.cpEditUrl }}/drafts/{{ entry.draftId }}">
				<input type="hidden" name="draftId" value="{{ entry.draftId }}">
				<input type="submit" class="btn submit" value="{{ 'Save Draft'|t }}">

				<input type="button" class="btn formsubmit" value="{{ 'Publish Draft'|t }}" data-action="entryRevisions/publishDraft" data-redirect="{{ entry.cpEditUrl }}/preview">

			{% elseif not isNewEntry and entry.classHandle == 'EntryVersion' %}

				<input type="hidden" name="action" value="entryRevisions/saveVersionAsDraft">
				<input type="hidden" name="redirect" value="{{ entry.cpEditUrl }}/drafts/{draftId}">
				<input type="hidden" name="versionId" value="{{ entry.versionId }}">
				<input type="submit" class="btn" value="{{ 'Save as Draft'|t }}">

			{% else %}

				<input type="hidden" name="action" value="entries/saveEntry">
				<input type="submit" class="btn submit" value="{{ 'Save'|t }}">

				{% if not isNewEntry and blx.hasPackage('publishpro') %}
					<input type="button" class="btn formsubmit" value="{{ 'Save as Draft'|t }}" value="entryRevisions/createDraft" data-action="entryRevisions/saveDraft" data-redirect="{{ entry.cpEditUrl }}/drafts/{draftId}">
				{% endif %}
			{% endif %}
		</div>
	</form>
{% endset %}


{% if entry is not defined or not entry.slug %}
	{% includeJs "new Blocks.ui.SlugGenerator('#title', '#slug');" %}
{% endif %}

