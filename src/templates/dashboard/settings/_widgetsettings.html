{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% if not widgetPackage and widgetId %}
	{% set widgetPackage = blx.dashboard.getUserWidgetById(widgetId) %}
	{% if not widgetPackage %}{% exit 404 %}{% endif %}
{% endif %}


{% if widgetPackage %}
	{% set widgetType = blx.dashboard.populateWidgetType(widgetPackage) %}
{% else %}
	{% set widgetType = blx.dashboard.getWidgetType('Feed') %}
{% endif %}


{% if widgetPackage.id %}
	{% set title = "{name} Settings"|t({ name: '<i>'~widgetType.title~'</i>' }) %}
{% else %}
	{% set title = "Add a new widget"|t %}
{% endif %}


{% set titlebar %}
	<h1>{{ title|raw }}</h1>
	<ul class="left">
		<li><a href="{{ url('dashboard/settings') }}" class="backbtn">{{ "Dashboard Settings"|t }}</a></li>
	</ul>
{% endset %}


{% set content %}
	<form method="post" action="" class="centered">
		<input type="hidden" name="action" value="dashboard/saveUserWidget">
		<input type="hidden" name="redirect" value="dashboard/settings">
		{% if widgetPackage.id %}<input type="hidden" name="widgetId" value="{{ widgetPackage.id }}">{% endif %}

		{% set widgetTypes = blx.dashboard.getAllWidgetTypes %}

		{{ forms.selectField({
			label: "Type",
			instructions: "What type of widget is this?"|t,
			id: 'class',
			name: 'class',
			options: widgetTypes,
			value: widgetType.classHandle,
			toggle: true
		}) }}

		{% for _widgetType in widgetTypes %}
			{% set isCurrent = (_widgetType.classHandle == widgetType.classHandle) %}
			{% if isCurrent %}
				{% set settings = widgetType.settings %}
			{% else %}
				{% set settings = _widgetType.settings %}
			{% endif %}

			{% if settings %}
				<div id="{{ _widgetType.classHandle }}" {% if not isCurrent %}style="display: none"{% endif %}>
					<hr>
					{% set namespace = 'types[' ~ _widgetType.classHandle ~ ']' %}
					{{- settings|ns(namespace)|raw -}}
					<hr>
				</div>
			{% endif %}
		{% endfor %}

		<div class="buttons">
			<input type="submit" class="btn submit" value="{{ 'Save'|t }}">
		</div>
	</form>
{% endset %}
