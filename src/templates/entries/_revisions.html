{% import "_includes/forms" as forms %}

{% set drafts = craft.entries()
    .draftOf(entry.sourceId)
    .siteId(entry.siteId)
    .anyStatus()
    .all() %}
{% set baseUrl = "entries/#{sectionHandle}/#{craft.app.request.getSegment(3)}/" %}
{% set parentIdParam = craft.app.request.getParam('parentId.0') ?: craft.app.request.getParam('parentId') %}
{% set params = parentIdParam ? { parentId: parentIdParam } : null %}

<div class="btngroup">
<div id="revision-btn" class="btn menubtn"{% if showSiteLabel %} data-icon="world"{% endif %}>{{ revisionLabel }}</div>

<div class="menu">
    {% if isMultiSiteEntry %}
        {% set siteGroups = craft.app.sites.getAllGroups() %}
        {% for group in siteGroups %}
            {% set groupSiteIds = group.getSiteIds()|intersect(siteIds) %}
            {% if groupSiteIds %}
                {% if siteGroups|length > 1 %}<h6>{{ group.name|t('site') }}</h6>{% endif %}
                <ul class="padded">
                    {% for siteId in groupSiteIds %}
                        {% set site = craft.app.sites.getSiteById(siteId) %}
                        {% set status = siteId in enabledSiteIds ? 'enabled' : 'disabled' %}
                        <li>
                            {% if siteId == entry.siteId %}
                                <a class="sel">
                                    <div class="status {{ status }}"></div>{{ site.name|t('site') }}
                                </a>
                            {% else %}
                                {% set url = url(baseUrl~site.handle, params) %}
                                <a href="{{ url }}">
                                    <div class="status {{ status }}"></div>{{ site.name|t('site') }}
                                </a>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endfor %}
    {% endif %}

    {% if isMultiSiteEntry %}
        <hr>
    {% endif %}

    <ul class="padded">
        {% set currentRevisionEditTime = entry.currentRevision.dateCreated ?? entry.dateUpdated %}
        <li><a{% if not entry.draftId and not entry.revisionId %} class="sel"{% endif %} href="{{ entry.getCpEditUrl() }}">{{ "Current"|t('app') }}
                <span class="light">
                    {{ currentRevisionEditTime|timestamp('short') }}
                    {%- if entry.currentRevision %}, {{ entry.currentRevision.creator }}{% endif %}
                </span>
            </a></li>
    </ul>

    {% if drafts %}
        <h6>{{ "Drafts"|t('app') }}</h6>
        <ul class="padded">
            {% for draft in drafts %}
                <li><a{% if draft.draftId == entry.draftId %} class="sel"{% endif %} href="{{ url(baseUrl~'drafts/'~draft.draftId) }}">
                        {{ draft.draftName }}
                        <span class="light">{{ "by {creator}"|t('app', { creator: draft.creator }) }}</span>
                    </a></li>
            {% endfor %}
        </ul>
    {% endif %}

    {% if section.enableVersioning %}
        {% set revisions = craft.entries()
            .revisionOf(entry.sourceId)
            .siteId(entry.siteId)
            .anyStatus()
            .offset(1)
            .limit(10)
            .orderBy('num desc')
            .all() %}
        {% if revisions %}
            <h6>{{ "Recent Revisions"|t('app') }}</h6>
            <ul class="padded">
                {% for revision in revisions %}
                    <li><a{% if revision.revisionId == entry.revisionId %} class="sel"{% endif %} href="{{ url(baseUrl~'revisions/'~revision.revisionId) }}">
                            {{ "Revision {num}"|t('app', { num: revision.revisionNum }) }}
                            <span class="light">{{ revision.dateCreated|timestamp('short') }}, {{ revision.getCreator() }}</span>
                        </a></li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endif %}
</div>

{% if entry.draftId %}
    {% do craft.app.session.authorize('editDraft:' ~ entry.draftId) %}
    <a id="editdraft-btn" class="btn edit icon" title="{{ 'Edit Draft Settings'|t('app') }}"></a>
    {% js %}
        new Craft.DraftEditor({{ entry.draftId }}, '{{ entry.draftName|e("js") }}', '{{ entry.draftNotes|e("js") }}');
    {% endjs %}
    {% do view.registerTranslations('app', [
        "Draft Name",
        "Notes",
    ]) %}
{% endif %}
</div>
