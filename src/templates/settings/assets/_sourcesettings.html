{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}


{% if not source and sourceId %}
	{% set source = blx.assets.getSourceById(sourceId) %}
	{% if not source %}{% exit 404 %}{% endif %}
{% endif %}


{% if source %}
	{% set sourceType = blx.assets.populateSourceType(source) %}
{% else %}
	{% set sourceType = blx.assets.getSourceType('Local') %}
{% endif %}


{% if source.id %}
	{% set title = "{name} Settings"|t({ name: '<i>'~source.name|t~'</i>' }) %}
{% else %}
	{% set title = "Create a new asset source"|t %}
{% endif %}


{% set titlebar %}
	<h1>{{ title|raw }}</h1>
	<ul class="left">
		<li><a href="{{ url('settings/assets') }}" class="backbtn">{{ "Assets"|t }}</a></li>
	</ul>
{% endset %}


{% set content %}
	<form method="post" action="" class="centered">
		<input type="hidden" name="action" value="assetSources/saveSource">
		<input type="hidden" name="redirect" value="settings/assets">
		{% if source.id %}<input type="hidden" name="sourceId" value="{{ source.id }}">{% endif %}

		{{ forms.textField({
			label: "Name"|t,
			id: 'name',
			name: 'name',
			value: source.name,
			errors: source.errors.name,
			first: true,
			required: true,
			translatable: true
		}) }}
		<!-- BLOCKS ONLY -->

		{% set settings = sourceType.settings %}
		{% set namespace = 'types[' ~ sourceType.classHandle ~ ']' %}
		{{- settings|ns(namespace)|raw -}}
		<!-- end BLOCKS ONLY -->
		<!-- BLOCKSPRO ONLY -->

		{% set sourceTypes = blx.assets.getAllSourceTypes %}

		{{ forms.selectField({
			label: "Type",
			instructions: "What type of source is this?"|t,
			id: 'type',
			name: 'type',
			options: sourceTypes,
			value: sourceType.classHandle,
			toggle: true
		}) }}

		{% for _sourceType in sourceTypes %}
			{% set isCurrent = (_sourceType.classHandle == sourceType.classHandle) %}
			{% if isCurrent %}
				{% set settings = sourceType.settings %}
			{% else %}
				{% set settings = _sourceType.settings %}
			{% endif %}

			{% if settings %}
				<div id="{{ _sourceType.classHandle }}" {% if not isCurrent %}style="display: none"{% endif %}>
					<hr>
					{% set namespace = 'types[' ~ _sourceType.classHandle ~ ']' %}
					{{- settings|ns(namespace)|raw -}}
					<hr>
				</div>
			{% endif %}
		{% endfor %}
		<!-- end BLOCKSPRO ONLY -->

		<div class="buttons">
			<input type="submit" class="btn submit" value="{{ 'Save'|t }}">
		</div>
	</form>
{% endset %}


{% if not source.handle %}
	{% includeJs "new Blocks.ui.HandleGenerator('#name', '#handle');" %}
{% endif %}
