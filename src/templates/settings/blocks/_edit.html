_{% layout "settings/_layouts/settings" pageTitle="Edit Content Block" %}

{% if !block && blockId %}
	{% set block = contentBlocks.getBlockById(blockId) %}
{% endif %}

{% region "main" %}
	<form method="post" action="">
		<input type="hidden" name="action" value="app/contentblocks/save" />
		<input type="hidden" name="redirect" value="settings/blocks" />
		{% if block.id %}<input type="hidden" name="block_id" value="{block.id}">{% endif %}

		<div class="pane">
			<div class="head">
				{% if block.id %}
					<h5>Edit Content Block {% if block.name %}“{block.name}”{% endif %}</h5>
				{% else %}
					<h5>Create a new content block</h5>
				{% endif %}
			</div>
			<div class="body">
				<div class="item field">
					<label for="name" class="required">Content Block Name</label>
					<div class="input-wrapper"><input id="name" name="name" class="{% if block.errors.name %}error{% endif %}" type="text" value="{block.name}" /></div>
					{% if block.errors.name %}
						{% include "_includes/error_list" errors=block.errors.name %}
					{% endif %}
				</div>
				<div class="item field">
					<label for="handle" class="required">Block Handle</label>
					<div class="input-wrapper"><input id="handle" name="handle" class="code {% if block.errors.handle %}error{% endif %}" type="text" value="{block.handle}" /></div>
					{% if block.errors.handle %}
						{% include "_includes/error_list" errors=block.errors.handle %}
					{% endif %}
				</div>
				<div class="item field">
					<label for="instructions">Instructions</label>
					<div class="input-wrapper"><textarea id="instructions" name="instructions" {% if block.errors.instructions %}class="error"{% endif %} rows="3" cols="100">{block.instructions}</textarea></div>
					{% if block.errors.instructions %}
						{% include "_includes/error_list" errors=block.errors.instructions %}
					{% endif %}
				</div>
				<div class="item field">
					<label for="class">Block Type</label>
					<div>
						<select id="class" name="class">
							{% foreach contentBlocks.blockTypes as blockType %}
								<option value="{blockType.class}" {% if (block && block.class == blockType.class) || (!block && blockType.class == 'PlainText') %}selected{% endif %}>{blockType.name}</option>
							{% endforeach %}
						</select>
					</div>
					{% if block.errors.class %}
						{% include "_includes/error_list" errors=block.errors.class %}
					{% endif %}
				</div>
			</div>
		</div>

		{% foreach contentBlocks.blockTypes as blockType %}
			{% if blockType.displaySettings %}
				<div id="{blockType.class}-settings" class="pane" {% if (block && block.class != blockType.class) || (!block && blockType.class != 'PlainText') %}style="display: none"{% endif %}>
					<div class="head">
						<h5>{blockType.name} Settings</h5>
					</div>
					<div class="body">
						{% if blockType.class == block.class %}
							{block.blockType.displaySettings}
						{% else %}
							{blockType.displaySettings}
						{% endif %}
					</div>
				</div>
			{% endif %}
		{% endforeach %}

		<input class="btn big submit" type="submit" value="Save Content Block" />
	</form>
{% endregion %}

{% region "scripts" %}
	{% include "_includes/js_include" file="app/scripts/block-settings.js" %}
	<script type="text/javascript">
		{% if !block.handle %}new blx.ui.HandleGenerator('#name', '#handle');{% endif %}
	</script>
{% endregion %}
