{% requireAdmin %}

{% extends (CraftEdition >= CraftClient ? "settings/email/_layout" : "_layouts/cp") %}

{% set crumbs = [
	{ label: "Settings"|t('app'), url: url('settings') }
] %}

{% if CraftEdition >= CraftClient %}
	{% set selectedTab = 'settings' %}
{% else %}
	{% set title = "Email Settings"|t('app') %}
{% endif %}

{% import "_includes/forms" as forms %}

{% includeTranslations
	"Email sent successfully! Check your inbox.",
	"An unknown error occurred."
%}


{% if settings is not defined %}
	{% set settings = craft.systemSettings.email %}
	{% set freshSettings = true %}
{% else %}
	{% set freshSettings = false %}
{% endif %}


{% block content %}
	{% registerjsresource "js/email_settings.js" %}

	<form id="settings-form" method="post" class="centered" accept-charset="UTF-8" data-saveshortcut>
		<input type="hidden" name="action" value="system-settings/save-email-settings">
		<input type="hidden" name="redirect" value="settings">

		{{ getCsrfInput() }}

		{{ forms.textField({
			first: true,
			label: "System Email Address"|t('app'),
			instructions: "The email address Craft will use when sending email."|t('app'),
			id: 'fromEmail',
			name: 'fromEmail',
			value: settings.fromEmail,
			autofocus: true,
			required: true,
			errors: (freshSettings ? null : settings.getErrors('fromEmail'))
		}) }}

		{{ forms.textField({
			label: "Sender Name"|t('app'),
			instructions: "The “From” name Craft will use when sending email."|t('app'),
			id: 'fromName',
			name: 'fromName',
			value: settings.fromName,
			required: true,
			errors: (freshSettings ? null : settings.getErrors('fromName'))
		}) }}

		{% if CraftEdition >= CraftClient %}
			{{ forms.textField({
				label: "HTML Email Template"|t('app'),
				instructions: "The template Craft will use for HTML emails"|t('app'),
				id: 'template',
				name: 'template',
				value: settings.template,
				errors: (freshSettings ? null : settings.getErrors('template'))
			}) }}
		{% endif %}

		<hr>

		{{ forms.selectField({
			label: "Protocol"|t('app'),
			instructions: "The protocol Craft will use to send email."|t('app'),
			id: 'protocol',
			name: 'protocol',
			options: [
				{ value: 'php', label: "PHP Mail"|t('app') },
				{ value: 'sendmail', label: "Sendmail"|t('app') },
				{ value: 'smtp', label: "SMTP"|t('app') },
				{ value: 'gmail', label: "Gmail"|t('app') }
			],
			value: settings.protocol
		}) }}

		<div id="hidden-fields" class="hidden">
			{{ forms.textField({
				label: "Username"|t('app'),
				id: 'username',
				name: 'username',
				value: settings.username,
				errors: (settings.protocol != 'Smtp' ? (freshSettings ? null : settings.getErrors('username')) : null)
			}) }}

			{{ forms.passwordField({
				label: "Password"|t('app'),
				id: 'password',
				name: 'password',
				value: settings.password,
				errors: (settings.protocol != 'Smtp' ? (freshSettings ? null : settings.getErrors('password')) : null)
			}) }}

			{{ forms.textField({
				label: "Port"|t('app'),
				id: 'port',
				name: 'port',
				value: settings.port,
				size: 4,
				errors: (freshSettings ? null : settings.getErrors('port'))
			}) }}

			{{ forms.textField({
				label: "Host Name"|t('app'),
				id: 'host',
				name: 'host',
				value: settings.host,
				errors: (freshSettings ? null : settings.getErrors('host'))
			}) }}

			{{ forms.textField({
				label: "Timeout"|t('app'),
				id: 'timeout',
				name: 'timeout',
				value: settings.timeout,
				size: 2,
				errors: (freshSettings ? null : settings.getErrors('timeout'))
			}) }}

			{{ forms.checkboxField({
				label: "Use authentication"|t('app'),
				id: 'useAuthentication',
				name: 'useAuthentication',
				checked: settings.useAuthentication,
				toggle: 'smtpAuthCredentials-field'
			}) }}

			<div id="smtpAuthCredentials-field" class="nested-fields{% if not settings.useAuthentication %} hidden{% endif %}">
				{{ forms.textField({
					label: "Username"|t('app'),
					id: 'smtp-username',
					name: 'smtpUsername',
					value: settings.username,
					errors: (settings.protocol == 'Smtp' ? (freshSettings ? null : settings.getErrors('username')) : null)
				}) }}

				{{ forms.passwordField({
					label: "Password"|t('app'),
					id: 'smtpPassword',
					name: 'smtpPassword',
					value: settings.password,
					errors: (settings.protocol == 'Smtp' ? (freshSettings ? null : settings.getErrors('password')) : null)
				}) }}
			</div>

			{{ forms.selectField({
				label: "Encryption Method",
				id: 'encryptionMethod',
				name: 'encryptionMethod',
				options: [
					{ value: '', label: "None"|t('app') },
					{ value: 'ssl', label: "SSL"|t('app') },
					{ value: 'tls', label: "TLS"|t('app') }
				],
				default: 'none',
				value: settings.encryptionMethod
			}) }}
		</div>

		<hr>

		<div class="buttons">
			<input class="btn submit" type="submit" value="{{ 'Save'|t('app') }}">
			<div id="test" class="btn">{{ "Test"|t('app') }}</div>
			<div id="test-spinner" class="spinner hidden"></div>
		</div>
	</form>
{% endblock %}
