!function(p){Craft.PluginManager=Garnish.Base.extend({init:function(){Craft.postActionRequest("app/get-plugin-license-info",p.proxy(function(e,n){if("success"===n)for(var t in e)e.hasOwnProperty(t)&&(e[t].isInstalled?new a(p("#plugin-"+t)).update(e[t]):this.addUninstalledPluginRow(t,e[t]))},this))},addUninstalledPluginRow:function(e,n){var t=p("#plugins");t.length||(t=p("<table/>",{id:"plugins",class:"data fullwidth collapsible",html:"<tbody></tbody>"}),p("#no-plugins").replaceWith(t));var a=p("<tr/>").appendTo(t.children("tbody")).append(p("<th/>").append(p("<div/>",{class:"plugin-infos"}).append(p("<div/>",{class:"icon"}).append(p("<img/>",{src:n.iconUrl}))).append(p("<div/>",{class:"details"}).append(p("<h2/>",{text:n.name})).append(n.description?p("<p/>",{text:n.description}):p()).append(n.documentationUrl?p("<p/>",{class:"links"}).append(p("<a/>",{href:n.documentationUrl,target:"_blank",text:Craft.t("app","Documentation")})):p()).append(p("<div/>",{class:"flex license-key"}).append(p("<div/>").append(p("<input/>",{class:"text code",size:29,maxlength:29,value:Craft.PluginManager.normalizeUserKey(n.licenseKey),readonly:!0,disabled:!0}))))))).append(p("<td/>",{class:"nowrap","data-title":Craft.t("app","Status")}).append(p("<span/>",{class:"status"})).append(p("<span/>",{class:"light",text:Craft.t("app","Missing")}))).append(n.latestVersion?p("<td/>",{class:"nowrap thin","data-title":Craft.t("app","Action")}).append(p("<form/>",{method:"post","accept-charset":"UTF-8"}).append(p("<input/>",{type:"hidden",name:"action",value:"pluginstore/install"})).append(p("<input/>",{type:"hidden",name:"packageName",value:n.packageName})).append(p("<input/>",{type:"hidden",name:"handle",value:e})).append(p("<input/>",{type:"hidden",name:"version",value:n.latestVersion})).append(p("<input/>",{type:"hidden",name:"licenseKey",value:n.licenseKey})).append(p("<input/>",{type:"hidden",name:"return",value:"settings/plugins"})).append(Craft.getCsrfInput()).append(p("<div/>",{class:"btngroup"}).append(p("<div/>",{class:"btn menubtn","data-icon":"settings"})).append(p("<div/>",{class:"menu","data-align":"right"}).append(p("<ul/>").append(p("<li/>").append(p("<a/>",{class:"formsubmit",text:Craft.t("app","Install")}))))))):p());Craft.initUiElements(a)}},{normalizeUserKey:function(e){return e.replace(/.{4}/g,"$&-").substr(0,29).toUpperCase()}});var a=Garnish.Base.extend({$row:null,$keyContainer:null,$keyInput:null,$spinner:null,handle:null,updateTimeout:null,init:function(e){this.$row=e,this.$keyContainer=e.find(".license-key"),this.$keyInput=this.$keyContainer.find("input.text").removeAttr("readonly"),this.$spinner=e.find(".spinner"),this.handle=this.$row.data("handle"),this.addListener(this.$keyInput,"focus","onKeyFocus"),this.addListener(this.$keyInput,"textchange","onKeyChange")},getKey:function(){return this.$keyInput.val().replace(/\-/g,"").toUpperCase()},onKeyFocus:function(){this.$keyInput.select()},onKeyChange:function(){this.updateTimeout&&clearTimeout(this.updateTimeout);var e=this.getKey();if(0===e.length||24===e.length){var n=Craft.PluginManager.normalizeUserKey(e);this.$keyInput.val(n).data("garnish-textchange-value",n),this.updateTimeout=setTimeout(p.proxy(this,"updateLicenseStatus"),100)}},updateLicenseStatus:function(){this.$spinner.removeClass("hidden"),Craft.postActionRequest("app/update-plugin-license",{handle:this.handle,key:this.getKey()},p.proxy(function(e,n){this.$spinner.addClass("hidden"),"success"===n&&this.update(e)},this))},update:function(e){var n=this.$row.find(".license-key-status");if("valid"==e.licenseKeyStatus||e.hasIssues){var t=p("<span/>",{class:"license-key-status "+e.licenseKeyStatus});n.length?n.replaceWith(t):t.appendTo(this.$row.find(".icon"))}else n.length&&n.remove();var a=e.licenseKey||"unknown"!==e.licenseKeyStatus;a?this.$keyContainer.removeClass("hidden"):this.$keyContainer.addClass("hidden"),a&&e.hasIssues?this.$keyInput.addClass("error"):this.$keyInput.removeClass("error");var s=this.$row.find("p.error");if(a&&e.licenseStatusMessage){var i=p("<p/>",{class:"error",html:e.licenseStatusMessage});s.length?s.replaceWith(i):i.insertAfter(this.$row.find(".license-key"))}else s.remove()}})}(jQuery);
//# sourceMappingURL=PluginManager.min.js.map